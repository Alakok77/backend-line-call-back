<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE Login ‚Äì Send user info</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>LINE Login Demo</h2>
  <button id="loginBtn">Login ‡∏î‡πâ‡∏ß‡∏¢ LINE</button>
  <div id="result" style="margin-top:20px;"></div>

  <script>
    // üü© ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const LIFF_ID = "2008301054-NWkx35W4";
    // üü© ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á backend (‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏™‡πà / ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢)
    const BACKEND_URL = "https://mirier-vagrantly-regena.ngrok-free.dev";

    async function loginWithLINE() {
      try {
        // 1Ô∏è‚É£ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
        await liff.init({ liffId: LIFF_ID });

        // 2Ô∏è‚É£ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà login ‚Üí ‡πÉ‡∏´‡πâ login ‡∏Å‡πà‡∏≠‡∏ô
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
          return;
        }

        // 3Ô∏è‚É£ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const profile = await liff.getProfile();
        const payload = {
          userId: profile.userId,
          name: profile.displayName,
          timestamp: new Date().toISOString()
        };

        // 4Ô∏è‚É£ ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        document.getElementById("result").innerHTML = `
          <p><b>UserID:</b> ${payload.userId}</p>
          <p><b>Name:</b> ${payload.name}</p>
          <p><b>Timestamp:</b> ${payload.timestamp}</p>
          <p style="color:gray;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend...</p>
        `;

        console.log("üì¶ Payload:", payload);

        // 5Ô∏è‚É£ ‡∏¢‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend
        const res = await fetch(`${BACKEND_URL}/api/customer/details`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();

        // 6Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        if (res.ok) {
          console.log("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", text);
          document.getElementById("result").innerHTML += `
            <p style="color:green;">‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
          `;
        } else {
          console.warn("‚ö†Ô∏è ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", text);
          document.getElementById("result").innerHTML += `
            <p style="color:orange;">‚ö†Ô∏è ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (status: ${res.status})</p>
          `;
        }

      } catch (err) {
        console.error("üí• Error:", err);
        document.getElementById("result").innerHTML += `
          <p style="color:red;">üí• ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</p>
        `;
      }
    }

    document.getElementById("loginBtn").addEventListener("click", loginWithLINE);
  </script>
</body>
</html>
